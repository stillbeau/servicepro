<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Countertop Service Request | FLOFORM</title>
  <style>
    :root {
      --primary: #2d2d2d;
      --primary-light: #4a4a4a;
      --accent: #5b7b2f;
      --accent-hover: #4a6625;
      --bg: #f5f6f3;
      --card: #ffffff;
      --text: #2d2d2d;
      --text-light: #6b6b6b;
      --border: #d6d9d0;
      --error: #c0392b;
      --success: #5b7b2f;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    header {
      background: #ffffff;
      color: var(--text);
      padding: 1.25rem 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-bottom: 3px solid var(--accent);
    }

    header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .logo-area {
      display: flex;
      align-items: center;
      gap: 1.25rem;
    }

    header .logo-area img {
      height: 48px;
      width: auto;
    }

    header h1 {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--primary);
    }

    header p {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }

    .intro {
      text-align: center;
      padding: 2rem 0 1rem;
    }

    .intro h2 {
      font-size: 1.6rem;
      margin-bottom: 0.5rem;
      color: var(--accent);
    }

    .intro p {
      color: var(--text-light);
      max-width: 540px;
      margin: 0 auto;
    }

    .steps {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin: 1.5rem 0 2rem;
      flex-wrap: wrap;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .step-num {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    .card h3 {
      font-size: 1.1rem;
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--bg);
      color: var(--accent);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group.full {
      grid-column: 1 / -1;
    }

    label {
      display: block;
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.35rem;
      color: var(--text);
    }

    label .required {
      color: var(--error);
    }

    input, select, textarea {
      width: 100%;
      padding: 0.65rem 0.85rem;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
      background: white;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(91,123,47,0.15);
    }

    input.invalid, select.invalid, textarea.invalid {
      border-color: var(--error);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Photo upload styles */
    .photo-tip {
      background: #f0f4ea;
      border: 1px solid #c5d4a8;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.25rem;
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
    }

    .photo-tip .icon {
      font-size: 1.4rem;
      flex-shrink: 0;
      line-height: 1;
    }

    .photo-tip p {
      font-size: 0.85rem;
      color: #3d5a1a;
    }

    .photo-tip strong {
      color: #2d4512;
    }

    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 2rem 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      margin-bottom: 1rem;
    }

    .upload-area:hover,
    .upload-area.dragover {
      border-color: var(--accent);
      background: #f0f4ea;
    }

    .upload-area .upload-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .upload-area p {
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .upload-area p strong {
      color: var(--accent);
      text-decoration: underline;
      cursor: pointer;
    }

    .upload-area .upload-hint {
      font-size: 0.8rem;
      color: #999;
      margin-top: 0.35rem;
    }

    .photo-previews {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
    }

    .photo-preview {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 4 / 3;
      background: var(--bg);
    }

    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-preview .remove-photo {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .photo-preview .remove-photo:hover {
      background: var(--error);
    }

    .photo-preview .photo-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.5);
      color: white;
      font-size: 0.7rem;
      padding: 3px 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Submit and status styles */
    .submit-section {
      text-align: center;
      padding: 0.5rem 0 2.5rem;
    }

    .btn-submit {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.85rem 2.5rem;
      font-size: 1.05rem;
      font-weight: 700;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      font-family: inherit;
      min-width: 220px;
    }

    .btn-submit:hover {
      background: var(--accent-hover);
    }

    .btn-submit:active {
      transform: scale(0.98);
    }

    .btn-submit:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    .btn-submit .spinner {
      display: none;
      width: 18px;
      height: 18px;
      border: 2.5px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    .btn-submit.loading .spinner {
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .submit-note {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-top: 0.75rem;
    }

    .error-msg {
      color: var(--error);
      font-size: 0.8rem;
      margin-top: 0.25rem;
      display: none;
    }

    .error-msg.show {
      display: block;
    }

    .form-status {
      display: none;
      padding: 1.25rem 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      text-align: center;
    }

    .form-status.success {
      display: block;
      background: #f0f4ea;
      border: 1px solid #c5d4a8;
      color: #3d5a1a;
    }

    .form-status.error {
      display: block;
      background: #fdf0ef;
      border: 1px solid #f0b8b1;
      color: #8b2019;
    }

    .form-status h3 {
      margin-bottom: 0.5rem;
      font-size: 1.15rem;
    }

    .form-status.success h3 {
      color: var(--accent);
    }

    .form-status.error h3 {
      color: var(--error);
    }

    .form-status p {
      font-size: 0.9rem;
    }

    footer {
      text-align: center;
      padding: 1.5rem 0;
      color: var(--text-light);
      font-size: 0.8rem;
      border-top: 1px solid var(--border);
    }

    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .steps {
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
      }

      .card {
        padding: 1.25rem;
      }

      header h1 {
        font-size: 1.25rem;
      }

      .photo-previews {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
    }
  </style>
</head>
<body>

<header>
  <div class="container">
    <div class="logo-area">
      <img src="https://floform.com/wp-content/uploads/2023/05/FloForm_logo.png" alt="FloForm - Countertops for Life">
      <div>
        <h1>Countertop Service</h1>
        <p>Service Request Form</p>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <div class="intro">
    <h2>Request Countertop Service</h2>
    <p>Fill out the form below and we'll get back to you as soon as possible.</p>
  </div>

  <div class="steps">
    <div class="step"><span class="step-num">1</span> Fill out details</div>
    <div class="step"><span class="step-num">2</span> Upload photos</div>
    <div class="step"><span class="step-num">3</span> Submit request</div>
  </div>

  <!-- Success / Error messages -->
  <div id="formStatus" class="form-status"></div>

  <form id="serviceForm" novalidate>

    <!-- Contact Information -->
    <div class="card">
      <h3>Contact Information</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="firstName">First Name <span class="required">*</span></label>
          <input type="text" id="firstName" required>
          <div class="error-msg">First name is required.</div>
        </div>
        <div class="form-group">
          <label for="lastName">Last Name <span class="required">*</span></label>
          <input type="text" id="lastName" required>
          <div class="error-msg">Last name is required.</div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="email">Email <span class="required">*</span></label>
          <input type="email" id="email" required>
          <div class="error-msg">Please enter a valid email address.</div>
        </div>
        <div class="form-group">
          <label for="phone">Phone <span class="required">*</span></label>
          <input type="tel" id="phone" required placeholder="(555) 123-4567">
          <div class="error-msg">Phone number is required.</div>
        </div>
      </div>
      <div class="form-group">
        <label for="address">Service Address <span class="required">*</span></label>
        <input type="text" id="address" required placeholder="Street address, city, province/state, postal code">
        <div class="error-msg">Service address is required.</div>
      </div>
    </div>

    <!-- Service Details -->
    <div class="card">
      <h3>Service Details</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="requestType">Type of Request <span class="required">*</span></label>
          <select id="requestType" required>
            <option value="">-- Select --</option>
            <option value="Chip Repair">Chip Repair</option>
            <option value="Crack Repair">Crack Repair</option>
            <option value="Seam Issue">Seam Issue</option>
            <option value="Stain or Discoloration">Stain or Discoloration</option>
            <option value="Loose or Separated Countertop">Loose or Separated Countertop</option>
            <option value="Sink or Faucet Issue">Sink or Faucet Issue</option>
            <option value="General Maintenance">General Maintenance</option>
            <option value="Other">Other</option>
          </select>
          <div class="error-msg">Please select a request type.</div>
        </div>
        <div class="form-group">
          <label for="material">Countertop Material <span class="required">*</span></label>
          <select id="material" required>
            <option value="">-- Select --</option>
            <option value="Quartz">Quartz</option>
            <option value="Granite">Granite</option>
            <option value="Marble">Marble</option>
            <option value="Laminate">Laminate</option>
            <option value="Solid Surface">Solid Surface</option>
            <option value="Butcher Block">Butcher Block</option>
            <option value="Other">Other</option>
            <option value="Not Sure">Not Sure</option>
          </select>
          <div class="error-msg">Please select a material.</div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="installDate">Approximate Install Date</label>
          <input type="text" id="installDate" placeholder="e.g. March 2023 or Unknown">
        </div>
        <div class="form-group">
          <label for="urgency">Urgency</label>
          <select id="urgency">
            <option value="Normal">Normal</option>
            <option value="Urgent - Affecting daily use">Urgent - Affecting daily use</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="description">Description of the Issue <span class="required">*</span></label>
        <textarea id="description" required placeholder="Please describe the issue in as much detail as possible. Where is the damage? When did you first notice it? How large is the affected area?"></textarea>
        <div class="error-msg">Please describe the issue.</div>
      </div>
    </div>

    <!-- Photo Upload -->
    <div class="card">
      <h3>Upload Photos <span class="required">*</span></h3>
      <div class="photo-tip">
        <span class="icon">&#128247;</span>
        <div>
          <p><strong>Tip: Place a coin next to the damage in at least one photo.</strong> This helps us accurately assess the size and scale of the issue.</p>
        </div>
      </div>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">&#128206;</div>
        <p><strong>Click to upload</strong> or drag and drop</p>
        <p class="upload-hint">Up to 3 photos (JPG, PNG) &middot; Max 10 MB each</p>
        <input type="file" id="photoInput" accept="image/jpeg,image/png,image/webp,image/heic" multiple hidden>
      </div>
      <div class="error-msg" id="photoError">Please upload at least one photo.</div>
      <div class="photo-previews" id="photoPreviews"></div>
    </div>

    <!-- Submit -->
    <div class="submit-section">
      <button type="submit" class="btn-submit" id="submitBtn">
        <span class="spinner"></span>
        <span class="btn-text">Submit Service Request</span>
      </button>
      <p class="submit-note">Your request and photos will be sent directly to our service team.</p>
    </div>

  </form>
</main>

<footer>
  <div class="container">
    &copy; 2026 FLOFORM Countertops. All rights reserved.
  </div>
</footer>

<script>
  const form = document.getElementById('serviceForm');
  const uploadArea = document.getElementById('uploadArea');
  const photoInput = document.getElementById('photoInput');
  const photoPreviews = document.getElementById('photoPreviews');
  const photoError = document.getElementById('photoError');
  const submitBtn = document.getElementById('submitBtn');
  const formStatus = document.getElementById('formStatus');

  const MAX_PHOTOS = 3;
  const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB
  const RESIZE_MAX_DIM = 1600;
  const JPEG_QUALITY = 0.8;

  let uploadedPhotos = []; // { file, dataUrl, resizedBase64, name }

  // --- Upload area interactions ---
  uploadArea.addEventListener('click', () => photoInput.click());

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
  });

  photoInput.addEventListener('change', () => {
    handleFiles(photoInput.files);
    photoInput.value = '';
  });

  function handleFiles(fileList) {
    const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));

    for (const file of files) {
      if (uploadedPhotos.length >= MAX_PHOTOS) break;
      if (file.size > MAX_FILE_SIZE) {
        alert(`"${file.name}" exceeds 10 MB and was skipped.`);
        continue;
      }
      processImage(file);
    }

    photoError.classList.remove('show');
  }

  function processImage(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const resizedBase64 = resizeImage(img, file.type);
        const photo = {
          name: file.name,
          dataUrl: e.target.result,
          resizedBase64: resizedBase64,
        };
        uploadedPhotos.push(photo);
        renderPreviews();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  function resizeImage(img, mimeType) {
    const canvas = document.createElement('canvas');
    let { width, height } = img;

    if (width > RESIZE_MAX_DIM || height > RESIZE_MAX_DIM) {
      if (width > height) {
        height = Math.round(height * RESIZE_MAX_DIM / width);
        width = RESIZE_MAX_DIM;
      } else {
        width = Math.round(width * RESIZE_MAX_DIM / height);
        height = RESIZE_MAX_DIM;
      }
    }

    canvas.width = width;
    canvas.height = height;

    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, width, height);

    // Always output as JPEG for consistent size
    const dataUrl = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
    // Return just the base64 portion (strip data:image/jpeg;base64,)
    return dataUrl.split(',')[1];
  }

  function renderPreviews() {
    photoPreviews.innerHTML = '';

    uploadedPhotos.forEach((photo, index) => {
      const div = document.createElement('div');
      div.className = 'photo-preview';
      div.innerHTML = `
        <img src="${photo.dataUrl}" alt="${photo.name}">
        <button type="button" class="remove-photo" data-index="${index}">&times;</button>
        <div class="photo-name">${photo.name}</div>
      `;
      photoPreviews.appendChild(div);
    });

    // Update upload area visibility
    if (uploadedPhotos.length >= MAX_PHOTOS) {
      uploadArea.style.display = 'none';
    } else {
      uploadArea.style.display = '';
    }
  }

  photoPreviews.addEventListener('click', (e) => {
    const btn = e.target.closest('.remove-photo');
    if (!btn) return;
    const index = parseInt(btn.dataset.index, 10);
    uploadedPhotos.splice(index, 1);
    renderPreviews();
  });

  // --- Field validation ---
  function validateField(field) {
    const errorMsg = field.parentElement.querySelector('.error-msg');
    let valid = true;

    if (field.hasAttribute('required') && !field.value.trim()) {
      valid = false;
    }

    if (field.type === 'email' && field.value.trim()) {
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(field.value.trim())) {
        valid = false;
      }
    }

    if (valid) {
      field.classList.remove('invalid');
      if (errorMsg) errorMsg.classList.remove('show');
    } else {
      field.classList.add('invalid');
      if (errorMsg) errorMsg.classList.add('show');
    }

    return valid;
  }

  form.querySelectorAll('input, select, textarea').forEach(field => {
    field.addEventListener('blur', () => validateField(field));
    field.addEventListener('input', () => {
      if (field.classList.contains('invalid')) {
        validateField(field);
      }
    });
  });

  // --- Form submission ---
  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    // Validate fields
    const requiredFields = form.querySelectorAll('[required]');
    let allValid = true;

    requiredFields.forEach(field => {
      if (!validateField(field)) allValid = false;
    });

    // Validate photos
    if (uploadedPhotos.length === 0) {
      photoError.classList.add('show');
      allValid = false;
    }

    if (!allValid) {
      const firstInvalid = form.querySelector('.invalid') || (uploadedPhotos.length === 0 ? uploadArea : null);
      if (firstInvalid) {
        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return;
    }

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.classList.add('loading');
    submitBtn.querySelector('.btn-text').textContent = 'Sending...';
    formStatus.className = 'form-status';
    formStatus.style.display = 'none';

    const payload = {
      firstName: document.getElementById('firstName').value.trim(),
      lastName: document.getElementById('lastName').value.trim(),
      email: document.getElementById('email').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      address: document.getElementById('address').value.trim(),
      requestType: document.getElementById('requestType').value,
      material: document.getElementById('material').value,
      installDate: document.getElementById('installDate').value.trim(),
      urgency: document.getElementById('urgency').value,
      description: document.getElementById('description').value.trim(),
      photos: uploadedPhotos.map(p => ({
        name: p.name.replace(/\.[^.]+$/, '') + '.jpg',
        content: p.resizedBase64,
      })),
    };

    try {
      const res = await fetch('/.netlify/functions/send-service-request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || 'Something went wrong. Please try again.');
      }

      // Success
      form.style.display = 'none';
      formStatus.className = 'form-status success';
      formStatus.innerHTML = `
        <h3>Request Submitted Successfully</h3>
        <p>Thank you! Our service team has received your request and photos. We'll be in touch within 1-2 business days.</p>
      `;
      formStatus.scrollIntoView({ behavior: 'smooth', block: 'center' });

    } catch (err) {
      formStatus.className = 'form-status error';
      formStatus.innerHTML = `
        <h3>Submission Failed</h3>
        <p>${err.message}</p>
      `;
      formStatus.scrollIntoView({ behavior: 'smooth', block: 'center' });

      submitBtn.disabled = false;
      submitBtn.classList.remove('loading');
      submitBtn.querySelector('.btn-text').textContent = 'Submit Service Request';
    }
  });
</script>

</body>
</html>
